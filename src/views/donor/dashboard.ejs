<%- include('../partials/header') %>

<%- include('../partials/navbar') %>

<div class="container pt-4">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="display-6 fw-bold mb-3">Donor Dashboard</h1>
        <div class="rounded-3 border bg-gradient p-4 mb-4"
            style="background: linear-gradient(90deg, #e0e7ff 0%, #f3e8ff 100%);">
            <h2 class="h5 fw-semibold mb-2">Welcome back!</h2>
            <p class="text-secondary mb-0">Thank you for making a difference in reducing food waste and helping
                those in need.</p>
        </div>
    </div>
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card text-center shadow-sm border-0 stats-card">
                <div class="card-body">
                    <div class="display-6 fw-bold text-warning mb-2"> <%= donationStats.assigned %> </div>
                    <p class="text-muted mb-0">Assigned Donations</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card text-center shadow-sm border-0 stats-card">
                <div class="card-body">
                    <div class="display-6 fw-bold text-primary mb-2"> <%= donationStats.new %> </div>
                    <p class="text-muted mb-0">New Donations</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card text-center shadow-sm border-0 stats-card">
                <div class="card-body">
                    <div class="display-6 fw-bold text-success mb-2"> <%= donationStats.completed %> </div>
                    <p class="text-muted mb-0">Completed Donations</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card text-center shadow-sm border-0 stats-card">
                <div class="card-body">
                    <div class="display-6 fw-bold text-info mb-2"> <%= donationStats.total %> </div>
                    <p class="text-muted mb-0">Total Donations</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Tabs -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-body">
            <h3 class="h4 fw-semibold mb-3">Donation Records</h3>
            <ul class="nav nav-tabs mb-3" id="donationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all"
                        type="button" role="tab">All</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button"
                        role="tab">New</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending"
                        type="button" role="tab">Pending</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="picked-tab" data-bs-toggle="tab" data-bs-target="#picked"
                        type="button" role="tab">Picked</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed"
                        type="button" role="tab">Completed</button>
                </li>
            </ul>
            <div class="tab-content" id="donationTabsContent">
                <div class="tab-pane fade active show" id="all" role="tabpanel" aria-labelledby="all-tab">
                    <div class="table-responsive">
                        <table class="table donation-table align-middle table-bordered border rounded-2 shadow-sm overflow-hidden tr-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Food Items</th>
                                    <!-- <th>Type</th> -->
                                    <th>Cook Date &amp; Time</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-table-body">
                        
                                <% donations.forEach((donation, index)=> { %>
                                    <tr>
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                        
                                        <td class="col-title">
                                            <a href="/donations/<%= donation._id %>" class="text-decoration-none text-dark">
                                                <%= donation.title %>
                                            </a>
                                        </td>
                        
                                        <td class="col-items">
                                            <i class="fa-solid fa-box-open pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                            <%= donation.items.map(i=> i.name).join(", ") %>
                                        </td>
                        
                                        <!-- <td style="min-width: auto;">
                                            <div>
                                                <div class="badge badge-type rounded-4 px-3 py-2 m-1">
                                                    Raw
                                                </div>
                                            </div>
                                        </td> -->
                        
                                        <td class="col-cookdate">
                                            <div>
                                                <i class="fa-regular fa-calendar pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookedDate ? donation.items[0].cookedDate.toISOString().split("T")[0] : 'N/A'
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fa-regular fa-clock" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookedTime || 'N/A' %>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <span class="badge badge-<%= donation.status.toLowerCase() %>">
                                                <%= donation.status %>
                                            </span>
                                        </td>
                        
                                        <td class="col-images">
                                            <div class="border rounded p-1 text-center mx-auto" style="max-width: 100px;">
                                                <% if (donation.images && donation.images.length> 0) { %>
                                                    <img src="<%= donation.images[0] %>" alt="food item" class="img-fluid">
                                                <% } else { %>
                                                    <img src="/default-food.png" alt="no img" class="img-fluid">
                                                <% } %>
                        
                                                <div class="text-center hover-blue" data-bs-toggle="modal"
                                                    data-bs-target="#images-modal" data-images="<%= donation.images.join(',') %>">
                                                    View all
                                                </div>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <div class="mx-auto text-center">
                                                <% if(donation.status === "New") { %>
                                                    <a href="/donations/<%= donation._id %>/edit" class="btn btn-sm btn-outline-primary m-1" title="Edit">
                                                        <i class="fas fa-pencil"></i>
                                                    </a>
                            
                                                    <button class="btn btn-sm btn-outline-danger m-1" title="Delete"
                                                        onclick="deleteDonation('<%= donation._id %>')">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                <% } else { %>
                                                    <!-- View button in anchor tag with eye -->
                                                    <a href="/donations/<%= donation._id %>" class="btn btn-sm btn-outline-secondary m-1" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="new" role="tabpanel" aria-labelledby="new-tab">
                    <div class="table-responsive">
                        <table class="table donation-table align-middle table-bordered border rounded-2 shadow-sm overflow-hidden tr-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Food Items</th>
                                    <!-- <th>Type</th> -->
                                    <th>Cook Date &amp; Time</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-table-body">
                        
                                <% donations.filter((d)=>d.status === 'New').forEach((donation, index)=> { %>
                                    <tr>
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                        
                                        <td class="col-title">
                                            <a href="/donations/<%= donation._id %>" class="text-decoration-none text-dark">
                                                <%= donation.title %>
                                            </a>
                                        </td>
                        
                                        <td class="col-items">
                                            <i class="fa-solid fa-box-open pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                            <%= donation.items.map(i=> i.name).join(", ") %>
                                        </td>
                        
                                        <!-- <td style="min-width: auto;">
                                            <div>
                                                <div class="badge badge-type rounded-4 px-3 py-2 m-1">
                                                    Raw
                                                </div>
                                            </div>
                                        </td> -->
                        
                                        <td class="col-cookdate">
                                            <div>
                                                <i class="fa-regular fa-calendar pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookDate ? donation.items[0].cookDate.toISOString().split("T")[0] : 'N/A'
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fa-regular fa-clock" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookTime || 'N/A' %>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <span class="badge badge-<%= donation.status.toLowerCase() %>">
                                                <%= donation.status %>
                                            </span>
                                        </td>
                        
                                        <td class="col-images">
                                            <div class="border rounded p-1 text-center mx-auto" style="max-width: 100px;">
                                                <% if (donation.images && donation.images.length> 0) { %>
                                                    <img src="<%= donation.images[0] %>" alt="food item" class="img-fluid">
                                                <% } else { %>
                                                    <img src="/default-food.png" alt="no img" class="img-fluid">
                                                <% } %>
                        
                                                <div class="text-center hover-blue" data-bs-toggle="modal"
                                                    data-bs-target="#images-modal" data-images="<%= donation.images.join(',') %>">
                                                    View all
                                                </div>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <div class="mx-auto text-center">
                                                <a href="/donations/<%= donation._id %>/edit" class="btn btn-sm btn-outline-primary m-1" title="Edit">
                                                    <i class="fas fa-pencil"></i>
                                                </a>
                        
                                                <button class="btn btn-sm btn-outline-danger m-1" title="Delete"
                                                    onclick="deleteDonation('<%= donation._id %>')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                    <div class="table-responsive">
                        <table class="table donation-table align-middle table-bordered border rounded-2 shadow-sm overflow-hidden tr-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Food Items</th>
                                    <!-- <th>Type</th> -->
                                    <th>Cook Date &amp; Time</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-table-body">
                        
                                <% donations.filter((d)=>d.status === 'Pending').forEach((donation, index)=> { %>
                                    <tr onclick="window.location='/donations/<%= donation._id %>'" style="cursor: pointer">
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                        
                                        <td class="col-title">
                                            <%= donation.title %>
                                        </td>
                        
                                        <td class="col-items">
                                            <i class="fa-solid fa-box-open pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                            <%= donation.items.map(i=> i.name).join(", ") %>
                                        </td>
                        
                                        <!-- <td style="min-width: auto;">
                                            <div>
                                                <div class="badge badge-type rounded-4 px-3 py-2 m-1">
                                                    Raw
                                                </div>
                                            </div>
                                        </td> -->
                        
                                        <td class="col-cookdate">
                                            <div>
                                                <i class="fa-regular fa-calendar pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookDate ? donation.items[0].cookDate.toISOString().split("T")[0] : 'N/A'
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fa-regular fa-clock" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookTime || 'N/A' %>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <span class="badge badge-<%= donation.status.toLowerCase() %>">
                                                <%= donation.status %>
                                            </span>
                                        </td>
                        
                                        <td class="col-images">
                                            <div class="border rounded p-1 text-center mx-auto" style="max-width: 100px;">
                                                <% if (donation.images && donation.images.length> 0) { %>
                                                    <img src="<%= donation.images[0] %>" alt="food item" class="img-fluid">
                                                <% } else { %>
                                                    <img src="/default-food.png" alt="no img" class="img-fluid">
                                                <% } %>
                        
                                                <div class="text-center hover-blue" data-bs-toggle="modal"
                                                    data-bs-target="#images-modal" data-images="<%= donation.images.join(',') %>">
                                                    View all
                                                </div>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <div class="mx-auto text-center">
                                                <a href="/donations/<%= donation._id %>" class="btn btn-sm btn-outline-secondary m-1" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="picked" role="tabpanel" aria-labelledby="picked-tab">
                    <div class="table-responsive">
                        <table class="table donation-table align-middle table-bordered border rounded-2 shadow-sm overflow-hidden tr-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Food Items</th>
                                    <!-- <th>Type</th> -->
                                    <th>Cook Date &amp; Time</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-table-body">
                        
                                <% donations.filter((d)=>d.status === 'Picked').forEach((donation, index)=> { %>
                                    <tr onclick="window.location='/donations/<%= donation._id %>'" style="cursor: pointer">
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                        
                                        <td class="col-title">
                                            <%= donation.title %>
                                        </td>
                        
                                        <td class="col-items">
                                            <i class="fa-solid fa-box-open pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                            <%= donation.items.map(i=> i.name).join(", ") %>
                                        </td>
                        
                                        <!-- <td style="min-width: auto;">
                                            <div>
                                                <div class="badge badge-type rounded-4 px-3 py-2 m-1">
                                                    Raw
                                                </div>
                                            </div>
                                        </td> -->
                        
                                        <td class="col-cookdate">
                                            <div>
                                                <i class="fa-regular fa-calendar pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookDate ? donation.items[0].cookDate.toISOString().split("T")[0] : 'N/A'
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fa-regular fa-clock" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookTime || 'N/A' %>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <span class="badge badge-<%= donation.status.toLowerCase() %>">
                                                <%= donation.status %>
                                            </span>
                                        </td>
                        
                                        <td class="col-images">
                                            <div class="border rounded p-1 text-center mx-auto" style="max-width: 100px;">
                                                <% if (donation.images && donation.images.length> 0) { %>
                                                    <img src="<%= donation.images[0] %>" alt="food item" class="img-fluid">
                                                <% } else { %>
                                                    <img src="/default-food.png" alt="no img" class="img-fluid">
                                                <% } %>
                        
                                                <div class="text-center hover-blue" data-bs-toggle="modal"
                                                    data-bs-target="#images-modal" data-images="<%= donation.images.join(',') %>">
                                                    View all
                                                </div>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <div class="mx-auto text-center">
                                                <a href="/donations/<%= donation._id %>" class="btn btn-sm btn-outline-secondary m-1" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
                    <div class="table-responsive">
                        <table class="table donation-table align-middle table-bordered border rounded-2 shadow-sm overflow-hidden tr-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>Food Items</th>
                                    <!-- <th>Type</th> -->
                                    <th>Cook Date &amp; Time</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-table-body">
                        
                                <% donations.filter((d)=>d.status === 'Completed').forEach((donation, index)=> { %>
                                    <tr onclick="window.location='/donations/<%= donation._id %>'" style="cursor: pointer">
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                        
                                        <td class="col-title">
                                            <%= donation.title %>
                                        </td>
                        
                                        <td class="col-items">
                                            <i class="fa-solid fa-box-open pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                            <%= donation.items.map(i=> i.name).join(", ") %>
                                        </td>
                        
                                        <!-- <td style="min-width: auto;">
                                            <div>
                                                <div class="badge badge-type rounded-4 px-3 py-2 m-1">
                                                    Raw
                                                </div>
                                            </div>
                                        </td> -->
                        
                                        <td class="col-cookdate">
                                            <div>
                                                <i class="fa-regular fa-calendar pe-1" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookDate ? donation.items[0].cookDate.toISOString().split("T")[0] : 'N/A'
                                                    %>
                                            </div>
                                            <div>
                                                <i class="fa-regular fa-clock" style="color: #666666; font-size: 0.9rem;"></i>
                                                <%= donation.items[0]?.cookTime || 'N/A' %>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <span class="badge badge-<%= donation.status.toLowerCase() %>">
                                                <%= donation.status %>
                                            </span>
                                        </td>
                        
                                        <td class="col-images">
                                            <div class="border rounded p-1 text-center mx-auto" style="max-width: 100px;">
                                                <% if (donation.images && donation.images.length> 0) { %>
                                                    <img src="<%= donation.images[0] %>" alt="food item" class="img-fluid">
                                                <% } else { %>
                                                    <img src="/default-food.png" alt="no img" class="img-fluid">
                                                <% } %>
                        
                                                <div class="text-center hover-blue" data-bs-toggle="modal"
                                                    data-bs-target="#images-modal" data-images="<%= donation.images.join(',') %>">
                                                    View all
                                                </div>
                                            </div>
                                        </td>
                        
                                        <td>
                                            <div class="mx-auto text-center">
                                                <a href="/donations/<%= donation._id %>" class="btn btn-sm btn-outline-secondary m-1" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                        
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Transparent Modal for viewing images -->
<%- include('../partials/viewImagesModal') %>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Donation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this donation? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    let donationToDelete = null;
    
    function deleteDonation(donationId) {
        donationToDelete = donationId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        fetch(`/donations/${donationToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then((res) => res.json())
        .then((data) => {
            if (data.success) {
                showAlert('success', data.message || 'Donation deleted successfully.');
                setTimeout(() => {
                    const deleteModalEl = document.getElementById('deleteModal');
                    const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
                    deleteModal.hide();
                    location.reload();
                }, 500);
            } else {
                showAlert('danger', data.message || 'Failed to delete donation.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while deleting the donation.');
        });
    });
</script>

<%- include('../partials/footer') %>